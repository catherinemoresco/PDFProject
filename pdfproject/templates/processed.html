<!doctype html>

<html>
	{% include 'head.html' %}
		{% assets "scss_read" %}
		<link rel="stylesheet" type="text/css" href="{{ ASSET_URL }}"/>	
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/svg.min.js') }}"></script>		
		{% endassets %}	
	<div class=page>
		{% block body %}
			<div class="pdf-pages">
				{% for r in result %}
					<div class="page-wrapper" style="width:75vw;padding-bottom:{{ratio}}%;position:relative;margin-left:auto;margin-right:auto;">
						<div id="{{r}}" class="pdf-page" style="background-image:url(/{{r}})"></div>	
					</div>
				{% endfor %}
			</div>

		{% endblock %}
	</div>
	<script type="text/javascript">
		var initX,initY,mousedown,dynamicRect;
		var jsonArray = $.getJSON( "{{jsondata}}", function() {
			console.log( "success" );
		})
		.done(function() {
			console.log( "second success" );
		})
		.fail(function() {
			console.log( "error" );
		})
		.always(function() {
			console.log( "complete" );
		});
		//console.log(jsonArray);
		var divs = document.getElementsByClassName('pdf-page');
		var len = divs.length;
		var divDraws = [];
		var j =0;
		{% for r in result %}
			divDraws[j] = SVG("{{r}}");
			j = j+1;
		{% endfor %}
		for(var i =0; i<len;i++){
			divs[i].id = i;
			divs[i].addEventListener("mousedown",function(event){
				if(event.button == 0){
					initX = event.pageX-this.offsetLeft-this.offsetParent.offsetLeft;
					initY= event.pageY-this.offsetTop-this.offsetParent.offsetTop;
					//alert("X: "+initX+" Y: "+initY);
					mousedown = true;
					console.log(this.offsetTop);
				}
			})
			divs[i].addEventListener("mousemove",function(){
				if(mousedown){
					var endX = event.pageX-this.offsetLeft-this.offsetParent.offsetLeft;
					var endY= event.pageY-this.offsetTop-this.offsetParent.offsetTop;
					if(endX<initX || endY<initY){
						mousedown =false;
						return true;
					}
					if(dynamicRect){
						dynamicRect.width(endX-initX).height(endY-initY)
					}
					else{
						dynamicRect = divDraws[eval(this.id)].rect(endX-initX,endY-initY).move(initX,initY).fill('#FFFF66').opacity('0.5');
					}
				}

			})
			divs[i].addEventListener("mouseup",function(event){
				if(dynamicRect){
					dynamicRect.remove();
					dynamicRect = false;
				}	
				if(mousedown){
					mousedown = false;			
					var endX = event.pageX-this.offsetLeft-this.offsetParent.offsetLeft;
					var endY= event.pageY-this.offsetTop-this.offsetParent.offsetTop;
					var rect = divDraws[eval(this.id)].rect(endX-initX,endY-initY).move(initX,initY).fill('#FFFF66').opacity('0.5');
					rect.dblclick(function(){
						this.remove();
					})
				}			
			})
		}
	</script>
</html>
