<!doctype html>

<html>
	{% include 'head.html' %}
		{% assets "scss_read" %}
		<link rel="stylesheet" type="text/css" href="{{ ASSET_URL }}"/>	
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/svg.min.js') }}"></script>		
		{% endassets %}	
	<div class=page>
		{% block body %}
			{% for r in result %}
				<div id="{{r}}" class="pdf-page"></div>	
			{% endfor %}
		{% endblock %}
	</div>
	<script type="text/javascript" src="{{ url_for('static', filename='js/processed.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/jsPDF/dist/jspdf.min.js') }}"></script>
	<script type="text/javascript">
		// Input: a string of the form "#ffc8b0"
		// Output: A list of RGB components as integers, of the form [255, 200, 176]
		function hexstring_to_numlist(fillColor) {
			var c = [fillColor.substring(1,3), fillColor.substring(3,5), fillColor.substring(5,7)];
			c = c.map(function(component){ return parseInt(component,16) });
			return c;
		}

		function export_to_pdf(method) {
			method = typeof method !== 'undefined' ? method : "datauristring";

			var i, j, k;
			for(i=0; i < divDraws.length; i++) {
				// Get all the rectangular highlights in the document.
				// TODO: Add more annotation types here once supported
				rects = divDraws[i].children().filter(function(el){return el.type=="rect"});

				rect_list = []; // list of rects we need to draw in the PDF

				for(j=0; j<rects.length; j++) {
					var rect_list_item = new Array();
					// Note: These properties are string type.
					rect_list_item["pos_x"] = parseInt( rects[j].node.getAttribute("x") );
					rect_list_item["pos_y"] = parseInt( rects[j].node.getAttribute("y") );
					rect_list_item["width"] = parseInt( rects[j].node.getAttribute("width") );
					rect_list_item["height"] = parseInt( rects[j].node.getAttribute("height") );
					fillColor = rects[j].node.getAttribute("fill");
					rect_list_item["fillColor_decimal"] = hexstring_to_numlist(fillColor);
					rect_list_item["opacity"] = parseInt( rects[j].node.getAttribute("opacity") );

					//rect_list.push([pos_x, pos_y, width, height, fillColor_decimal, opacity]);
					rect_list.push(rect_list_item);
				}

				// Create a new jsPDF document to hold our annotations
				var doc = new jsPDF();

				// Import the current PDF as the base layer.
				doc.addPage();

				// Tell jsPDF to draw each rectangle
				for(k = 0; k < rect_list.length; k++) {
					doc.setFillColor(rect_list[k]["fillColor_decimal"][0], rect_list[k]["fillColor_decimal"][1], rect_list[k]["fillColor_decimal"][2], rect_list[k]["opacity"]);
					doc.rect(rect_list[k]["pos_x"], rect_list[k]["pos_y"], rect_list[k]["width"], rect_list[k]["height"], "F");
					doc.setFillColor(0,0,0,0.9);
					doc.rect(0,k * 120,100,100, "F");
				}
			}
			return doc.output(method);
		}

	</script>
</html>
