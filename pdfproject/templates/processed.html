<!doctype html>

<html>
	{% include 'head.html' %}
		{% assets "scss_read" %}
		<link rel="stylesheet" type="text/css" href="{{ ASSET_URL }}"/>	
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script type="text/javascript" src="{{ url_for('static', filename='js/svg.min.js') }}"></script>		
		{% endassets %}	
	<div class=page>
		{% block body %}
			{% for r in result %}
				<div id="{{r}}" class="pdf-page"></div>	
			{% endfor %}
		{% endblock %}
	</div>
	<script type="text/javascript">
		var  divs = document.getElementsByClassName('pdf-page');
		var divLen = divs.length;
		var divDraws= [];
		var initX,initY,mousedown,dynamicRect;
		for(var i=0;i<divLen;i++){
			divID = divs[i].id;
			divDraws[i] = SVG(divID);
			var fpath = '/'+divs[i].id;
			var image = divDraws[i].image(fpath);
			divID = i;
			divs[i].id = divID;
			scale(image,divs[i]);
			divs[i].addEventListener("mousedown",function(event){
				if(event.button == 0){
					initX = event.pageX-this.offsetLeft-this.offsetParent.offsetLeft;
					initY= event.pageY-this.offsetTop-this.offsetParent.offsetTop;
					//alert("X: "+initX+" Y: "+initY);
					mousedown = true;
					console.log(this.offsetTop);
				}
			})
			
			divs[i].addEventListener("mousemove",function(){
				if(mousedown){
					var endX = event.pageX-this.offsetLeft-this.offsetParent.offsetLeft;
					var endY= event.pageY-this.offsetTop-this.offsetParent.offsetTop;
					if(endX<initX || endY<initY){
						mousedown =false;
						return true;
					}
					if(dynamicRect){
						dynamicRect.width(endX-initX).height(endY-initY)
					}
					else{
						dynamicRect = divDraws[eval(this.id)].rect(endX-initX,endY-initY).move(initX,initY).fill('#FFFF66').opacity('0.5');
					}
				}

			})
			
			divs[i].addEventListener("mouseup",function(event){
				if(dynamicRect){
					dynamicRect.remove();
					dynamicRect = false;
				}	
				if(mousedown){
					mousedown = false;			
					var endX = event.pageX-this.offsetLeft-this.offsetParent.offsetLeft;
					var endY= event.pageY-this.offsetTop-this.offsetParent.offsetTop;
					var rect = divDraws[eval(this.id)].rect(endX-initX,endY-initY).move(initX,initY).fill('#FFFF66').opacity('0.5');
					rect.dblclick(function(){
						this.remove();
					})
					
				}			
			})
		}
		function scale (img,divElem){
			//var w =window.innerWidth;
			var w =1024;
			divElem.style.width = (w + "px");
			img.loaded(function(loader){
				var h = (1/loader.ratio)*w;
				img.size(w,h);
				divElem.style.height = (h + "px");
			})		
		}

		// Input: a string of the form "#ffc8b0"
		// Output: A list of RGB components as integers, of the form [255, 200, 176]
		function hexstring_to_numlist(fillColor) {
			var c = [fillColor.substring(1,3), fillColor.substring(3,5), fillColor.substring(5,7)];
			c = c.map(function(component){ return parseInt(component,16) });
			return c;
		}

		for(current_page_draws in divDraws) {
			// Get all the rectangular highlights in the document.
			// TODO: Add more annotation types here once supported
			rects = current_page_draws.children().filter(function(el){return el.type=="rect"});
		
			rect_list = []; // list of rects we need to draw in the PDF
		
			for(current_rect in rects) {
				// Note: These properties are string type.
				pos_x = current_rect.node.getAttribute("x");
				pos_y = current_rect.node.getAttribute("y");
				width = current_rect.node.getAttribute("width");
				height = current_rect.node.getAttribute("height");
				fillColor = current_rect.node.getAttribute("fill");
				fillColor_decimal = hexstring_to_numlist(fillColor);
				opacity = current_rect.node.getAttribute("opacity");
		
				rect_list.push([pos_x, pos_y, width, height, fillColor_decimal, opacity]);
			}
		
			// Create a new jsPDF document to hold our annotations
			var doc = new jsPDF();
		
			// Import the current PDF as the base layer.
			doc.addPage();
		
			// Tell jsPDF to draw each rectangle
			for(r in rect_list) {
				doc.setFillColor(r.fillColor);
				doc.rect(r.pos_x, r.pos_y, r.width, r.height, "F");
			}
		}


	</script>
</html>
